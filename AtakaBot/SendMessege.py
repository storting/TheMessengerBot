from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.common.action_chains import ActionChains
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from rusgenderdetection import get_gender
import pyperclip
import time
import pymorphy3
import re

# –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
morph = pymorphy3.MorphAnalyzer()

def is_personal_name(word):
    parsed_word = morph.parse(word)[0]
    return ('Name' in parsed_word.tag) or False

def decline_name(name):
    cleaned_text = re.sub(r'[^\u0400-\u04FF\s]', '', name)
    butyavka = morph.parse(cleaned_text.strip())[0]
    gent = butyavka.inflect({'gent'})
    
    return gent.word

# –ü—É—Ç—å –∫ –ø—Ä–æ—Ñ–∏–ª—é
PROFILE_PATH = r'C:/Users/evgen/AppData/Local/Google/Chrome/User Data/AppProfile'

def messageCraft(nameCustumer, nameBirthday):
    if(nameBirthday != None and nameBirthday != ''):
        declineName = decline_name(nameBirthday)
        print(declineName + "\t" + nameBirthday + "\t" + str(get_gender(declineName)))
        if(is_personal_name(declineName) and get_gender(declineName) == 1):
            text = f"""
                *{nameCustumer}* –¥–æ–±—Ä—ã–π –¥–µ–Ω—å!‚ò∫üå∫‚ù§

                –í–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç –í–ª–∞–¥–∏—Å–ª–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ª–∞–∑–µ—Ä—Ç–∞–≥ –∫–ª—É–±–∞ –ê–¢–ê–ö–ê üî´üß®–Ω–∞ –¢—Ä–æ–ª–ª–µ–π–Ω–æ–π 37ü´°

                –ù–µ –∑–∞ –≥–æ—Ä–∞–º–∏ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –í–∞—à–µ–≥–æ —Å—ã–Ω–∞ *{declineName.title()}*üéÇ‚ù§, _–≤—ã –µ—â–µ –Ω–µ –¥—É–º–∞–ª–∏ –Ω–∞–¥ –ø–æ–¥–∞—Ä–∫–æ–ºüéÅ, –∫–∞–∫ –∏ –≥–¥–µ –±—É–¥–µ—Ç–µ –æ—Ç–º–µ—á–∞—Ç—å?üéàüéäüéâ_

                –ì–æ—Ç–æ–≤—ã –≤–∑—è—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–∞–∑–¥–Ω–∏–∫–∞ –≤ –Ω–∞—à–∏ –∑–∞–±–æ—Ç–ª–∏–≤—ã–µ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä—É–∫–∏:
                *-–õ–∞–∑–µ—Ä—Ç–∞–≥ –∏–≥—Ä–∞,*
                *-–ê–Ω–∏–º–∞—Ç–æ—Ä,*
                *-–§–æ—Ç–æ–≥—Ä–∞—Ñ,*
                *-–ö–æ–º–Ω–∞—Ç–∞ –æ—Ç–¥—ã—Ö–∞ –¥–ª—è –ø—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏—è,*
                *-–°–∫–∞–ª–∞–¥—Ä–æ–º*
                –ü—Ä–∏–≥–ª–∞—à–∞–µ–º –ø–æ—Å–µ—Ç–∏—Ç—å –Ω–∞—à –ª–∞–∑–µ—Ä—Ç–∞–≥ –∫–ª—É–±!üéØüî´

                –ü—Ä–∏—è—Ç–Ω—ã–π —Å—é—Ä–ø—Ä–∏–∑, —Ç–æ–ª—å–∫–æ –¥–ª—è –í–∞—Å *10% —Å–∫–∏–¥–∫–∞* –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏–≥—Ä—ã –ª–∞–∑–µ—Ä—Ç–∞–≥!üî•

                –í–º–µ—Å—Ç–æ ~1000 —Ä—É–±–ª–µ–π~ üôÖ‚Äç‚ôÄ‚õî, —Ü–µ–Ω–∞ 2-—Ö —á–∞—Å–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã –ø–æ —Å—Ç–∞—Ä—ã–º —Ü–µ–Ω–∞ *900—Ä—É–±–ª–µ–π* –∑–∞ –∏–≥—Ä–æ–∫–∞ üï∫üèªüî• 

                –ù–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –º–æ—Ä–µ —ç–º–æ—Ü–∏–π!üòç 

                –°–∞–π—Ç https://www.ataka154.ru/
                –í–∫  https://vk.com/ataka_154

                _üìå–ë—É–¥–µ–º –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã –∑–∞ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å, –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –≤ –Ω–∞—à–µ–º –∫–ª—É–±–µ –ª–∏–±–æ —É–∂–µ –¥—Ä—É–≥–∏–µ –ø–ª–∞–Ω—ã_

                PS: –ñ–µ–ª–∞—é —Ö–æ—Ä–æ—à–µ–≥–æ –í–∞–º –¥–Ω—è, –º–Ω–æ–≥–æ —É–ª—ã–±–æ–∫, –∏ —Å—á–∞—Å—Ç–ª–∏–≤—ã—Ö¬†–º–æ–º–µ–Ω—Ç–æ–≤!
                """
            return text
        elif(is_personal_name(declineName) and get_gender(declineName) != 1):
            text = f"""
                *{nameCustumer}* –¥–æ–±—Ä—ã–π –¥–µ–Ω—å!‚ò∫üå∫‚ù§

                –í–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç –í–ª–∞–¥–∏—Å–ª–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ª–∞–∑–µ—Ä—Ç–∞–≥ –∫–ª—É–±–∞ –ê–¢–ê–ö–ê üî´üß®–Ω–∞ –¢—Ä–æ–ª–ª–µ–π–Ω–æ–π 37ü´°

                –ù–µ –∑–∞ –≥–æ—Ä–∞–º–∏ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –í–∞—à–µ–π –¥–æ—á–µ—Ä–∏ *{declineName.title()}*üéÇ‚ù§, _–≤—ã –µ—â–µ –Ω–µ –¥—É–º–∞–ª–∏ –Ω–∞–¥ –ø–æ–¥–∞—Ä–∫–æ–ºüéÅ, –∫–∞–∫ –∏ –≥–¥–µ –±—É–¥–µ—Ç–µ –æ—Ç–º–µ—á–∞—Ç—å?üéàüéäüéâ_

                –ì–æ—Ç–æ–≤—ã –≤–∑—è—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–∞–∑–¥–Ω–∏–∫–∞ –≤ –Ω–∞—à–∏ –∑–∞–±–æ—Ç–ª–∏–≤—ã–µ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä—É–∫–∏:
                *-–õ–∞–∑–µ—Ä—Ç–∞–≥ –∏–≥—Ä–∞,*
                *-–ê–Ω–∏–º–∞—Ç–æ—Ä,*
                *-–§–æ—Ç–æ–≥—Ä–∞—Ñ,*
                *-–ö–æ–º–Ω–∞—Ç–∞ –æ—Ç–¥—ã—Ö–∞ –¥–ª—è –ø—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏—è,*
                *-–°–∫–∞–ª–∞–¥—Ä–æ–º*
                –ü—Ä–∏–≥–ª–∞—à–∞–µ–º –ø–æ—Å–µ—Ç–∏—Ç—å –Ω–∞—à –ª–∞–∑–µ—Ä—Ç–∞–≥ –∫–ª—É–±!üéØüî´

                –ü—Ä–∏—è—Ç–Ω—ã–π —Å—é—Ä–ø—Ä–∏–∑, —Ç–æ–ª—å–∫–æ –¥–ª—è –í–∞—Å *10% —Å–∫–∏–¥–∫–∞* –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏–≥—Ä—ã –ª–∞–∑–µ—Ä—Ç–∞–≥!üî•

                –í–º–µ—Å—Ç–æ ~1000 —Ä—É–±–ª–µ–π~ üôÖ‚Äç‚ôÄ‚õî, —Ü–µ–Ω–∞ 2-—Ö —á–∞—Å–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã –ø–æ —Å—Ç–∞—Ä—ã–º —Ü–µ–Ω–∞ *900—Ä—É–±–ª–µ–π* –∑–∞ –∏–≥—Ä–æ–∫–∞ üï∫üèªüî• 

                –ù–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –º–æ—Ä–µ —ç–º–æ—Ü–∏–π!üòç 

                –°–∞–π—Ç https://www.ataka154.ru/
                –í–∫  https://vk.com/ataka_154

                _üìå–ë—É–¥–µ–º –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã –∑–∞ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å, –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –≤ –Ω–∞—à–µ–º –∫–ª—É–±–µ –ª–∏–±–æ —É–∂–µ –¥—Ä—É–≥–∏–µ –ø–ª–∞–Ω—ã_

                PS: –ñ–µ–ª–∞—é —Ö–æ—Ä–æ—à–µ–≥–æ –í–∞–º –¥–Ω—è, –º–Ω–æ–≥–æ —É–ª—ã–±–æ–∫, –∏ —Å—á–∞—Å—Ç–ª–∏–≤—ã—Ö¬†–º–æ–º–µ–Ω—Ç–æ–≤!
                """
            return text
    else:        
        text = f"""
            *{nameCustumer}* –¥–æ–±—Ä—ã–π –¥–µ–Ω—å!‚ò∫üå∫‚ù§

            –í–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç –í–ª–∞–¥–∏—Å–ª–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ª–∞–∑–µ—Ä—Ç–∞–≥ –∫–ª—É–±–∞ –ê–¢–ê–ö–ê üî´üß®–Ω–∞ –¢—Ä–æ–ª–ª–µ–π–Ω–æ–π 37ü´°

            –ü—Ä–∏—à–ª–æ –≤—Ä–µ–º—è –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å –∏ —Ä–∞–∑–≤–ª–µ—á—å—Å—è, –≤ —ç—Ç–æ–º –º—ã –≤ —ç—Ç–æ–º –º–æ–∂–µ–º –æ—á–µ–Ω—å –ø–æ–º–æ—á—å!üß®‚ò∫
            
            –ì–æ—Ç–æ–≤—ã –≤–∑—è—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–∞–∑–¥–Ω–∏–∫–∞ –≤ –Ω–∞—à–∏ –∑–∞–±–æ—Ç–ª–∏–≤—ã–µ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä—É–∫–∏:
            *-–õ–∞–∑–µ—Ä—Ç–∞–≥ –∏–≥—Ä–∞,*
            *-–ê–Ω–∏–º–∞—Ç–æ—Ä,*
            *-–§–æ—Ç–æ–≥—Ä–∞—Ñ,*
            *-–ö–æ–º–Ω–∞—Ç–∞ –æ—Ç–¥—ã—Ö–∞ –¥–ª—è –ø—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏—è,*
            *-–°–∫–∞–ª–∞–¥—Ä–æ–º*
            –ü—Ä–∏–≥–ª–∞—à–∞–µ–º –ø–æ—Å–µ—Ç–∏—Ç—å –Ω–∞—à –ª–∞–∑–µ—Ä—Ç–∞–≥ –∫–ª—É–±!üéØüî´

            –ü—Ä–∏—è—Ç–Ω—ã–π —Å—é—Ä–ø—Ä–∏–∑, —Ç–æ–ª—å–∫–æ –¥–ª—è –í–∞—Å *10% —Å–∫–∏–¥–∫–∞* –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏–≥—Ä—ã –ª–∞–∑–µ—Ä—Ç–∞–≥!üî•

            –í–º–µ—Å—Ç–æ ~1000 —Ä—É–±–ª–µ–π~ üôÖ‚Äç‚ôÄ‚õî, —Ü–µ–Ω–∞ 2-—Ö —á–∞—Å–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã –ø–æ —Å—Ç–∞—Ä—ã–º —Ü–µ–Ω–∞ *900—Ä—É–±–ª–µ–π* –∑–∞ –∏–≥—Ä–æ–∫–∞ üï∫üèªüî• 

            –ù–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –º–æ—Ä–µ —ç–º–æ—Ü–∏–π!üòç 

            –°–∞–π—Ç https://www.ataka154.ru/
            –í–∫  https://vk.com/ataka_154

            _üìå–ë—É–¥–µ–º –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã –∑–∞ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å, –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –≤ –Ω–∞—à–µ–º –∫–ª—É–±–µ –ª–∏–±–æ —É–∂–µ –¥—Ä—É–≥–∏–µ –ø–ª–∞–Ω—ã_

            PS: –ñ–µ–ª–∞—é —Ö–æ—Ä–æ—à–µ–≥–æ –í–∞–º –¥–Ω—è, –º–Ω–æ–≥–æ —É–ª—ã–±–æ–∫, –∏ —Å—á–∞—Å—Ç–ª–∏–≤—ã—Ö¬†–º–æ–º–µ–Ω—Ç–æ–≤!
            """ 
        return text

def driverOpen():
    global chrome_options
    global driver
    # –ù–∞—Å—Ç—Ä–æ–∏–º –±—Ä–∞—É–∑–µ—Ä —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º
    chrome_options = Options()
    chrome_options.add_argument(f"--user-data-dir={PROFILE_PATH}")

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥—Ä–∞–π–≤–µ—Ä
    service = Service(ChromeDriverManager().install())
    driver = webdriver.Chrome(service=service, options=chrome_options)

def driverQuit():
    driver.quit()

def send_whatsapp_message(phone_number, name1, name2):
    message = messageCraft(name1, name2)
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    driver.get(f'https://web.whatsapp.com/send/?phone={phone_number}')
    pyperclip.copy(message)
    try:
        wait = WebDriverWait(driver, 60)
        # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        textbox = wait.until(EC.visibility_of_element_located((By.XPATH, '//*[@id="main"]//footer//div[@contenteditable="true"]')))
        
        # –©–µ–ª–∫–∞–µ–º –ø–æ –ø–æ–ª—é –≤–≤–æ–¥–∞
        textbox.click()
        
        # –í—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞
        textbox.send_keys(Keys.CONTROL, 'v')
        
        # –ñ–¥—ë–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –Ω–∞–∂–∏–º–∞–µ–º –µ—ë
        #send_button = wait.until(EC.element_to_be_clickable((By.XPATH, '//*[@id="main"]//button[@class="_4sWnG"]')))  # –ö–ª–∞—Å—Å –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è
        #send_button.click()
        textbox.send_keys("""
                          """)
        time.sleep(2)
        print("–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
    except Exception as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

